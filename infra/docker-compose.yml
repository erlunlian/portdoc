services:
  # PostgreSQL Database with pgvector
  db:
    image: ankane/pgvector:v0.5.1
    env_file:
      - ../.env
    healthcheck:
      test: pg_isready -U postgres -h localhost
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    ports:
      - 5432:5432
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: postgres
      POSTGRES_HOST_AUTH_METHOD: trust
    command: postgres -c listen_addresses='*'
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

  # FastAPI Backend
  # NOTE: For local development, run the API manually with hot reload:
  #   cd apps/api && source venv/bin/activate && uvicorn main:app --reload --port 8000
  # Uncomment below if you want to run the API in Docker (no hot reload):
  # api:
  #   build:
  #     context: ../apps/api
  #     dockerfile: ../../infra/Dockerfile.api
  #   depends_on:
  #     db:
  #       condition: service_healthy
  #   restart: unless-stopped
  #   ports:
  #     - 8000:8000
  #   environment:
  #     DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@db:5432/postgres
  #     SUPABASE_URL: http://kong:8000
  #     SUPABASE_SERVICE_ROLE_KEY: ${SERVICE_ROLE_KEY}
  #     SUPABASE_JWT_SECRET: ${JWT_SECRET}
  #     STORAGE_BUCKET: pdfs
  #     OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://ollama:11434/v1}
  #     OLLAMA_MODEL: ${OLLAMA_MODEL:-gemma3:12b}
  #     OLLAMA_EMBEDDING_MODEL: ${OLLAMA_EMBEDDING_MODEL:-mxbai-embed-large}
  #     ENVIRONMENT: development
  #     LOG_LEVEL: INFO
  #     CORS_ORIGINS: '["http://localhost:3000","http://localhost:54321"]'
  #   volumes:
  #     - ../apps/api:/app
  #     - api-storage:/tmp/storage

volumes:
  db-data:
  api-storage:

